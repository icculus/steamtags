<!doctype html>
<html>
  <head>
    <link href="style.css" rel="stylesheet" type="text/css" /> 
    <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
    <script type="text/javascript">
<!--

var profile = null;

function render()
{
    if (profile == null)
    {
        $('div.nickname').text("This user's profile is invalid or marked private");
        $('img.avatar').hide();
        return;
    } // if

    $('img.avatar').attr('src', profile.avatarurl_medium);
    $('div.nickname').text(profile.nickname);

    var gameidx;
    for (gameidx in profile.gamelist)
    {
        var game = profile.gamelist[gameidx];
        var html = "<tr><td class='gamecell'>" +
                   "<img width='123' height='45' src='" + game.logourl + "'/>" +
                "<td class='gamecell'>" +
                "<a href='steam://run/" + game.appid + "'>" + 
                "<h4>" + game.title + "</h4>" +
                "</a><p>Tags:";

        if (game.tags.length == 0)
            html += ' (none)';
        else
        {
            var tagidx;
            for (tagidx in game.tags)
                html += " " + game.tags[tagidx];
        } // else
        html += "</p></td></tr>";

        $('table.gametable > tbody:last').append(html);
    } // for
} // render

function process_steam_profile(xml)
{
    var prof = $(xml).find('profile');
    if (prof.find('steamid').text() == '0')
    {
        $('div.loginpopover').show();
        return null;
    } // if

    if (prof.find('valid').text() != '1')
        return null;

    var retval = {
        nickname: prof.find('nickname').text(),
        steamid: prof.find('steamid').text(),
        name: prof.find('name').text(),
        profileurl: prof.find('profileurl').text(),
        onlinestate: prof.find('onlinestate').text(),
        statemsg: prof.find('statemsg').text(),
        avatarurl_small: prof.find('avatarurl_small').text(),
        avatarurl_medium: prof.find('avatarurl_medium').text(),
        avatarurl_large: prof.find('avatarurl_large').text(),
        vacbanned: (prof.find('vacbanned').text() != '0'),
        membersince: prof.find('membersince').text(),
        rating: prof.find('rating').text(),
        hoursplayed_2weeks: prof.find('hoursplayed_2weeks').text(),
        headline: prof.find('headline').text(),
        location: prof.find('location').text(),
        realname: prof.find('realname').text(),
        summary: prof.find('summary').text(),
        weblinks: new Array(),
        gamelist: new Array(),
    }

    prof.find('weblink').each(function(){
        retval['weblinks'].push({
            title: $(this).find('title').text(),
            url: $(this).find('url').text(),
        });
    })

    prof.find('game').each(function(){
        var game = {
            appid: $(this).find('appid').text(),
            title: $(this).find('title').text(),
            logourl: $(this).find('logourl').text(),
            storeurl: $(this).find('storeurl').text(),
            tags: new Array,
        };

        $(this).find('tag').each(function(){
            game.tags.push($(this).text());
        });

        retval['gamelist'].push(game);
    });

    return retval;
} // process_steam_profile


$(document).ready(function(){
    var user = 'icculus';  // !!! FIXME
    $.ajax({
        type: "GET",
        url: "steamprofile.php?user=" + user,
        dataType: "xml",
        error: function(XMLHttpRequest, textStatus, errorThrown) {
                    var html = "<center><font color='#FF0000'>" +
                        "Failed to load Steam profile: " +
                        textStatus + " " + errorThrown +
                        "</font></center>";
                    $('div.content').html(html);
               },
        success: function(xml) { profile = process_steam_profile(xml); render(); }
    });
});
-->
    </script>
  </head>
  <body>
    <div class='loginpopover'>
        <center>
        <p>You need to login to Steam Community to access this page.</p>
        <p>We are forwarding you to steamcommunity.com.</p>
        <p>Your password will only be supplied to the Steam website and not
           to this one.</p>
        <p><a href='auth.php'>Go there now.</a></p>
        </center>
    </div>
    <div class='main'>
      <img class='avatar' src='loading.gif'/>
      <div class='nickname' style='display:inline;'>Loading your steam profile...</div>
      <table class='gametable'><tbody></tbody></table>
    </div>
  </body>
</html>

