<!doctype html>
<html>
  <head>
    <title>Steam Tags</title>
    <link href="style.css" rel="stylesheet" type="text/css" /> 
    <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
    <script type="text/javascript">
<!--

var profile = null;

// !!! FIXME: this is kinda nasty.
function resize_ui()
{
    var h = $(window).height();
    h -= $('div.global_header').height();
    h -= $('div.global_footer').height();
    $('div.scrollable').height(h - 10);
} // resize_ui

function render()
{
    if (profile == null)
        return;

    $('img.avatar').attr('src', profile.avatarurl_medium);
    $('div.nickname').text(profile.nickname);

    var gameidx;
    for (gameidx in profile.gamelist)
    {
        var game = profile.gamelist[gameidx];
        var html = "<tr class='gamerow' profilegameidx='" + gameidx + "'>" +
                   "<td class='gamecell'>" +
                   "<img width='123' height='45' src='" + game.logourl + "'/>" +
                   "<td class='gamecell'>" +
                   "<h4><a href='steam://run/" + game.appid + "'>" + 
                   game.title + "</a></h4><div class='tagline'>Tags:" +
                   "<div class='taglist' profilegameidx=" + gameidx + ">";

        if (game.tags.length == 0)
            html += ' (none)';
        else
        {
            var tagidx;
            for (tagidx in game.tags)
                html += " " + game.tags[tagidx];
        } // else
        html += "</div></div></td></tr>";

        $('table.gametable > tbody:last').append(html);
    } // for

    $('tr.gamerow').each(function() {
        profile.gamelist[$(this).attr('profilegameidx')].element = $(this);
    });

    $('div.taglist').one("click", function() { clicked_taglist($(this)); });
    $('div.searchbox').css('visibility', 'visible');
    resize_ui();
} // render

function popover(element)
{
    var windowWidth = document.documentElement.clientWidth;
    var windowHeight = document.documentElement.clientHeight;
    var popupWidth = windowWidth / 2;
    $(element).css('width', popupWidth);

    var popupHeight = $(element).height();

    $(element).css({
        position: 'absolute',
        top: (windowHeight - popupHeight) / 2,
        left: (windowWidth - popupWidth) / 2,
        width: popupWidth,
        height: popupHeight,
    });

    $('#backgroundpopover').css('height', windowHeight);
    $("#backgroundpopover").css('opacity', '0.7');
    $("#backgroundpopover").fadeIn('slow');
    $(element).fadeIn('slow');
} // popover

function process_steam_profile(xml)
{
    var prof = $(xml).find('profile');
    if (prof.find('steamid').text() == '0')
    {
        $('img.avatar').hide();
        popover('#loginpopover');
        return null;
    } // if

    if (prof.find('valid').text() != '1')
        return null;

    var retval = {
        nickname: prof.find('nickname').text(),
        steamid: prof.find('steamid').text(),
        name: prof.find('name').text(),
        profileurl: prof.find('profileurl').text(),
        onlinestate: prof.find('onlinestate').text(),
        statemsg: prof.find('statemsg').text(),
        avatarurl_small: prof.find('avatarurl_small').text(),
        avatarurl_medium: prof.find('avatarurl_medium').text(),
        avatarurl_large: prof.find('avatarurl_large').text(),
        vacbanned: (prof.find('vacbanned').text() != '0'),
        membersince: prof.find('membersince').text(),
        rating: prof.find('rating').text(),
        hoursplayed_2weeks: prof.find('hoursplayed_2weeks').text(),
        headline: prof.find('headline').text(),
        location: prof.find('location').text(),
        realname: prof.find('realname').text(),
        summary: prof.find('summary').text(),
        weblinks: new Array(),
        gamelist: new Array(),
        filter: '',
        tagmap: new Object(),
    }

    prof.find('weblink').each(function(){
        retval['weblinks'].push({
            title: $(this).find('title').text(),
            url: $(this).find('url').text(),
        });
    })

    prof.find('game').each(function(){
        var game = {
            appid: $(this).find('appid').text(),
            title: $(this).find('title').text(),
            logourl: $(this).find('logourl').text(),
            storeurl: $(this).find('storeurl').text(),
            tagmatchcount: 0,
            element: null,
            tags: new Array,
        };

        $(this).find('tag').each(function(){
            var t = $(this).text().toLowerCase();
            game.tags.push(t);
            if (retval.tagmap[t] == null)
                retval.tagmap[t] = new Array();
            retval.tagmap[t].push(game);
        });

        retval['gamelist'].push(game);
    });

    return retval;
} // process_steam_profile

var run_filter_timer = null;
function run_filter()
{
    // stop any pending filter runs.
    clearTimeout(run_filter_timer);
    run_filter_timer = null;

    var filter = '';
    var widget = $('input.tagfilter');

    // ignore text in box if we haven't focused it yet.
    if (widget && widget.attr('filter_cleared'))
        filter = widget.val();

    filter = filter.toLowerCase();
    filter = filter.replace(/^\s*|\s*$/g, '');

    if (profile.filter == filter)
        return;  // fast path: nothing's changed.

    profile.filter = filter;

    // fast path: can we just show everything?
    if (filter == '')   // just show everything.
    {
        $('tr.gamerow').show();
        return;
    } // if

    var filtertags = filter.split(' ');

    for (var t in filtertags)
    {
        // fast path: can we just hide everything?
        if (profile.tagmap[filtertags[t]] == null)
        {
            $('tr.gamerow').hide();   // no rows match this tag.
            return;
        } // if
    } // for

    for (var t in filtertags)
    {
        var tag = filtertags[t];
        for (var i in profile.tagmap[tag])
        {
            var game = profile.tagmap[tag][i];
            game.tagmatchcount++;
        } // for
    } // for

    // okay, now we have a list of games that should be filtered.
    for (var i in profile.gamelist)
    {
        var game = profile.gamelist[i];
        if (game.tagmatchcount != filtertags.length)
            game.element.hide();
        else
            game.element.show();
        game.tagmatchcount = 0;   // reset this for next time.
    } // for
} // run_filter

function focus_filter_textbox()
{
    // blank out the filter textbox when focused if it has default text.
    var widget = $('input.tagfilter');
    if (widget && !widget.attr('filter_cleared'))
    {
        widget.attr('filter_cleared', true);
        widget.val('');
    } // if
} // focus_filter_textbox

function typing_in_filter()
{
    // we only update the filter when it's been more than X ms, in case the
    //  list is massive.
    if (run_filter_timer != null)
        clearTimeout(run_filter_timer);
    run_filter_timer = setTimeout('run_filter();', 50);
} // typing_in_filter

function save_tags(appid, tagstr)
{
    // we only allow a-z, 0-9, and spaces. So URI encode the spaces.
    var tagstrurl = tagstr.replace(/ /g, '%20');
    $.ajax({
        type: 'GET',
        url: 'savetags.php?appid=' + appid + '&tags=' + tagstrurl,
        dataType: "xml",
        success: function(xml) {
            // !!! FIXME: we leave the tags dead if this fails for any reason.
            var resxml = $(xml).find('result');
            if ((resxml == null) || (resxml.text() != '1'))
                return;

            var appidxml = $(xml).find('appid');
            if (appidxml == null)
                return;

            // !!! FIXME: we can just upvalue here, right? Why iterate?
            var appid = appidxml.text();
            var game = null;
            for (var i in profile.gamelist)
            {
                if (profile.gamelist[i].appid == appid)
                {
                    game = profile.gamelist[i];
                    break;
                } // if
            } // for

            if (game == null)
                return;

            var element = game.element.find('div.taglist');
            if (element == null)
                return;

            // !!! FIXME: get this from the stylesheet
            element.css('color', '#FFFFFF');
            element.one("click", function() { clicked_taglist($(this)); });
        },
    });
} // save_tags

function process_tag_edit(element, tagstr)
{
    tagstr = tagstr.toLowerCase();
    tagstr = tagstr.replace(/^\s*|\s*$/g, '');
    tagstr = tagstr.replace(/\s+/g, ' ');
    tagstr = tagstr.replace(/[^a-z0-9 ]/g, '');

    // remove duplicate tags...
    var dupetags = tagstr.split(' ');
    var tags = new Array();
    for (var i in dupetags)
    {
        var dupe = false;
        for (var j in tags)
        {
            if (dupetags[i] == tags[j])
            {
                 dupe = true;
                 break;
            } // if
        } // for
        if (!dupe)
            tags.push(dupetags[i]);
    } // for
    tagstr = tags.join(' ');

    // update profile.gamelist[gameidx].tags and profile.tagmap...
    var parentdiv = element.parent();
    var gameidx = parentdiv.attr('profilegameidx');
    var game = profile.gamelist[gameidx];

    for (var i in game.tags)
    {
        var t = game.tags[i];
        var gamelist = profile.tagmap[t];
        for (var j = 0; j < gamelist.length; j++)
        {
            if (gamelist[j] == game)
            {
                gamelist.splice(j, 1);
                j--;
            } // if
        } // for
        if (gamelist.length == 0)
            profile.tagmap[t] = null;
    } // for

    for (var i in tags)
    {
        var t = tags[i];
        if (profile.tagmap[t] == null)
            profile.tagmap[t] = new Array();
        profile.tagmap[t].push(game);
    } // for

    game.tags = tags;

    // Push the updated tags back to the server for storage.
    save_tags(game.appid, tagstr);

    // Kill the text input widget, go back to regular text.
    if (tagstr == '')
        tagstr = '(none)';
    parentdiv.html(' ' + tagstr);
    // !!! FIXME: get this from the stylesheet
    parentdiv.css('color', '#777777');
} // process_tag_edit

function clicked_taglist(element)
{
    var editor = $("input.tagedit");
    if (editor)
        editor.blur();  // that should kill it.

    var tagstr = element.text().replace(/^\s*|\s*$/g, '');
    if (tagstr == '(none)')
        tagstr = '';

    var html = "<input size='100' class='tagedit' name='tagedit' type='text'" +
               "value='" + tagstr + "' autocomplete='off'/>";
    element.html(html);

    editor = $("input.tagedit");
    editor.blur(function() { process_tag_edit($(this), $(this).val()); });
    editor.change(function() { process_tag_edit($(this), $(this).val()); });
    editor.keyup(function(e) {
        if (e.keyCode != 27)
            return;
        // revert to original tags on escape.
        var parentdiv = $(this).parent();
        var gameidx = parentdiv.attr('profilegameidx');
        var game = profile.gamelist[gameidx];
        var tagstr = game.tags.join(' ');
        process_tag_edit($(this), tagstr);
    });
    editor.focus();
} // clicked_taglist

// kick off AJAX load of user profile when document is ready for action.
$(document).ready(function(){
    $(window).resize( function() { resize_ui(); } );
    $.ajax({
        type: "GET",
        url: "steamprofile.php",
        dataType: "xml",
        error: function(XMLHttpRequest, textStatus, errorThrown) {
            var html = "<center><font color='#FF0000'>" +
                       "Failed to load Steam profile: " +
                       textStatus + " " + errorThrown +
                       "</font></center>";
            $('div.content').html(html);
        },
        success: function(xml) {
            profile = process_steam_profile(xml);
            render();
        },
    });
});

-->
    </script>
  </head>
  <body>
    <div class='main'>
      <div class="global_header"> 
        <img class='avatar' width='64' height='64' src='loading.gif'/>
        <div class='nickname'></div>
        <div class='searchbox' style='visibility: hidden;'> 
          <input class='tagfilter' name='filter' type='text'
                 onFocus='focus_filter_textbox();' 
                 onBlur='run_filter();'
                 onChange='run_filter();' 
                 onKeyDown='typing_in_filter();' 
                 value='Enter filter tags' size='22' autocomplete='off'/>
        </div>
      </div>
      <div class='scrollable'>
        <table class='gametable'><tbody></tbody></table>
      </div>
      <div class='global_footer'>
      <center>
        [
        <a target='_blank' href='http://store.steampowered.com/'>buy games</a>
        -
        <a target='_blank' href='http://hg.icculus.org/icculus/steamtags'>source code</a>
        -
        <a href='auth.php?logout=1'>logout</a>
        ]
      </div>
    </div>

    <div id='loginpopover'>
        <center>
        <p>This website lets you organize and filter your Steam purchases
           through tags.</p>
        <br/>
        <p>You need to log in to Steam Community to access this page.</p>
        <p>Your password will only be supplied to the Steam website. This
           website will never have access to your login information.</p>
        <br/>
        <p><a style='text-decoration: underline;' href='auth.php'>
          Click here to log in through steamcommunity.com</a></p>
        </center>
    </div>
    <div id='backgroundpopover'></div>
  </body>
</html>

